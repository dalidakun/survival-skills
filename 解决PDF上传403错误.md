# 解决 PDF 上传 403 Forbidden 错误

## 错误原因

`Unexpected token 'F', "Forbidden "... is not valid JSON` 表示：
- GitHub API 返回了 403 Forbidden 错误
- 通常是 GitHub Token 权限不足或配置问题

## 解决步骤

### 1. 检查 GitHub Token 权限

GitHub Token 需要以下权限：
- ✅ **repo** (完整仓库访问权限)
  - 包括：`repo:status`, `repo_deployment`, `public_repo`, `repo:invite`, `security_events`

### 2. 检查 Vercel 环境变量

1. 登录 Vercel：https://vercel.com
2. 进入项目设置：**Settings** → **Environment Variables**
3. 检查以下变量：
   - `GITHUB_TOKEN` - 必须配置
   - `GITHUB_OWNER` - 仓库所有者（默认：`dalidakun`）
   - `GITHUB_REPO` - 仓库名称（默认：`survival-skills`）

### 3. 重新生成 GitHub Token（如果需要）

如果 Token 权限不足，需要重新生成：

1. 访问：https://github.com/settings/tokens
2. 点击 **Generate new token** → **Generate new token (classic)**
3. 设置：
   - **Note**: `survival-skills-upload`
   - **Expiration**: `No expiration`（或选择较长时间）
   - **Select scopes**: 勾选 **repo**（会自动选中所有 repo 相关权限）
4. 点击 **Generate token**
5. **复制 Token**（只显示一次！）
6. 在 Vercel 中更新 `GITHUB_TOKEN` 环境变量
7. **重新部署**项目（重要！）

### 4. 检查仓库权限

确保：
- Token 对应的 GitHub 账号有该仓库的 **写入权限**
- 如果是私有仓库，Token 必须有访问权限

### 5. 测试上传

1. 访问管理后台：`https://你的域名/admin`
2. 登录后，切换到 **上传 PDF** 标签页
3. 选择一个较小的 PDF 文件（< 30MB）测试上传
4. 查看错误信息（现在会显示更详细的错误）

## 常见问题

### Q: 为什么文件大小限制是 30MB？

A: GitHub API 对单个文件有 100MB 的限制，但通过 API 上传时使用 base64 编码，会增加约 33% 的大小。为了安全，限制为 30MB。

### Q: 如果文件超过 30MB 怎么办？

A: 可以：
1. 压缩 PDF 文件
2. 使用 Cloudflare R2 或七牛云存储（支持更大的文件）

### Q: 添加文章功能正常，但上传 PDF 失败？

A: 可能是：
- PDF 文件太大
- `public/pdfs/` 目录权限问题
- Token 权限虽然可以写入 `content/`，但无法写入 `public/pdfs/`

**解决方法**：确保 Token 有完整的 `repo` 权限。

## 验证 Token 是否有效

可以在命令行测试（需要安装 curl）：

```bash
# 替换 YOUR_TOKEN 为你的 GitHub Token
curl -H "Authorization: Bearer YOUR_TOKEN" https://api.github.com/user
```

如果返回你的用户信息，说明 Token 有效。

## 如果仍然失败

1. 检查 Vercel 部署日志：
   - Vercel Dashboard → **Deployments** → 点击最新的部署 → **Logs**
   - 查看是否有相关错误信息

2. 检查浏览器控制台：
   - 按 F12 打开开发者工具
   - 查看 **Console** 和 **Network** 标签
   - 查看上传请求的详细错误信息

3. 联系我并提供：
   - 错误信息截图
   - PDF 文件大小
   - Vercel 日志（如果有）

